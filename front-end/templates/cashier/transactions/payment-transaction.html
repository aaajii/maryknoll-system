{% extends 'base.html' %} {% block settings %}
<li class="nav-item active">
    <a class="nav-link" href="{% url 'settings' %}">Settings</a>
    <span class="sr-only">(current)</span>
</li>
{% endblock %}
{%block title%} Cashier Transaction {%endblock%}
{%load static%} {% block content %}
<div class="content-heading margin">
<form action="" class="heading-label">
    <div class="row">
    <div class="col-md-8">
        <div class="card">
        <div class="card-header link">
            Payment Details
        </div>
        <div class="card-body" id="paymentsPanel">
            <div class="row margin">
            <div class="col-md-8">
                <div class="heading">
                <label>Choose transaction:</label>
                </div>
                <div class="btn-group btn-group-sm transactions" role="group" aria-label="Choose Transaction">
                <button type="button" class="btn btn-secondary active" id="enrollmentBtn">Enrollment</button>
                <button type="button" class="btn btn-secondary" id="othersBtn">Others</button>
                </div>
            </div>
            <div class="col-md-2">
                <button type="button" id="btn-add" onclick="add()" class="btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> Add Payment</button>
                <button type="button" id="btn-add-particular" onclick="addParticular()" class="btn btn-primary"><i class="fa fa-plus" aria-hidden="true"></i> Add Item</button>
            </div>
            </div>
            <!-- ENROLLMENT -->
            <div class="enrollmentPayment">
            <div class="row payment">
                <div class="col">
                <h5 class="payment-heading">Payment Details #<span class="count">1</span></h5>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                <label class="card-subtitle">Particular:</label>
                <select class="custom-select btn-block" id="particularList" required>
                    <option selected value="None">Choose particular:</option>
                    <option value="EnrollmentFee">Enrollment Fee</option>
                    <option value="TuitionFee">Tuition Fee</option>
                </select>
                </div>
                <div class="col-md-6">
                <div class="details">
                    <label class="card-subtitle">Month:</label>  
                    <select class="custom-select btn-block" id="monthList" onchange="appendMonth(1)" required>  
                        <option selected value="None">Choose payment month:</option>
                        <option selected value="JAN">January</option>
                        <option selected value="FEB">Febuary</option>
                        <option selected value="MAR">March</option>
                        <option selected value="APR">April</option>
                        <option selected value="MAY">May</option>
                        <option selected value="JUN">June</option>
                        <option selected value="JUL">July</option>  
                        <option selected value="AUG">August</option>
                        <option selected value="SEP">September</option>
                        <option selected value="OCT">October</option>
                        <option selected value="NOV">November</option>
                        <option selected value="DEC">December</option>
                        
                    </select>
                </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                <div class="tuitionPayment">
                    <label class="card-subtitle">Amount:</label>  
                    <input onchange="recordTuitionPayment(1);" type="text" id="tuitionAmount" class="form-control tuitionAmount">
                </div>
                </div>
            </div>
            <div class="row" id="paymentTypeRow">
                <div class="col-md-6">
                <div id="paymentTypeInput">
                    <label class="card-subtitle">Payment Type:</label>
                    <select class="custom-select btn-block" id="paymentType" required>
                        <option value="None" selected>Choose payment type:</option>
                        <option value="Full">Full Payment</option>
                        <option value="Partial">Partial Payment</option>
                        <!-- `Full` here refers to paying the whole SY's balance.
                            while `partial` refers to downpayment -->
                    </select>
                </div> 
                </div>
                <div class="col-md-6">
                <div class="partial"> 
                    <label class="card-subtitle">Amount:</label>  
                    <input onchange="recordEnrollmentPartial();" type="text" class="form-control">
                </div>
                </div>
            </div>
            </div>
            <!-- OTHERS -->
            <div class="othersPayment">
            <div class="addParticularPayment">
                <div class="row">
                <div class="col-md-6">
                    <label class="card-subtitle">Particular Name:</label>
                    <select class="custom-select btn-block" id="feesParticularList" onchange="" name="payment0" required>
                    <option selected value="None">Choose particular:</option>
                    <option value="1">Form 137</option>
                    <option value="2">Diploma</option>
                    <option value="3">Certificate</option>
                    <option value="4">Entrance Test</option>
                    <option value="5">Identification Card</option>
                    <option value="6">Uniform</option>
                    <option value="7">Books</option>
                    <option value="others">Others</option>
                    </select>
                    <!-- is only saved in the student's payment transaction logs, but object is not saved in the database-->
                    <!-- DATA GENERATED FROM FEES AND ACCOUNTS TABLE VALUES -->
                    <!-- MODAL appears if others is selected -->
                    <div class="modal" tabindex="-1" role="dialog" id="othersModal">
                    <div class="modal-dialog modal-sm" role="document">
                        <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Item details</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                            <div class="col">
                                <label>Specific Name:</label>
                                <input type="text" class="form-control" onchange="recordSpecName(this.value, 0)"/>
                            </div>
                            </div>
                            <div class="row">
                            <div class="col">
                                <label>Price Amount:</label>
                                <input type="text" class="form-control" onchange="recordSpecAmount(this.value, 0)"/>
                            </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" onclick="transferData(0)" data-dismiss="modal" class="btn btn-primary" >Save Item</button>
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="others">
                    <label class="card-subtitle">Specify:</label>  
                    <h3 class="link" id="item-0">Level 3 Backpack</h3>  
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteParticularRow(this)">Remove</button>
                </div>
                </div>
                <div class="row">
                <div class="col-md-6">
                    <label class="card-subtitle">Price Amount:</label>
                    <h2 class="link" ><span class="currency" id="amount-0"> 0.00</span></h2>
                    <!-- corresponds to the user input
                        and/or the undocumented particular (others) -->
                </div>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
    <div class="col-md-4 payment-summary">
            
    </div>
    </div>
</form>
</div>

{%endblock%}

{%block backend_scripts%}

{# BACKEND SCRIPTS #}
<script src="{% static '02-javascript/cashier-scripts.js' %}"></script>
<script>
Number.prototype.formatMoney = function(c, d, t){
    var n = this, 
        c = isNaN(c = Math.abs(c)) ? 2 : c, 
        d = d == undefined ? "." : d, 
        t = t == undefined ? "," : t, 
        s = n < 0 ? "-" : "", 
        i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c))), 
        j = (j = i.length) > 3 ? j % 3 : 0;
        return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
        };
function updateAmountDue(){
    var total = 0
    $(".tuitionAmount").each(function(){
        curr = $(this).val()
        total = total + parseInt(curr)
    });
    $('#enrollmentAmount .currency').html(total.formatMoney(2, '.', ','))
}
$(function(){
    //Initializes object for serializing
    clear()
    //Some delay because cannot point to a non existent class(coz ajax has delay lol)
    generateSummaryCard();
    setTimeout(function(){ init(); }, 50);
});
$('.user').click(function(){
    console.log(backEndDataObject, othersData)
});
function generateSummaryCard(){
    $.ajax({
        url: '{% url "payment-summary" registration.enrollment_ID %}',
        type: 'get',
        dataType: 'json',
        success: function (data) {
          $(".payment-summary").html(data.html_form);
        }
    });
    
    
}
var backEndDataObject = {
    "particularType":"",
    "paymentType" : "",
    "partialAmount" : "",
    "months" : [],
    "tuitionAmount" : [],
    "payments": 0,
    "payment_method":"",
    "ORNumber":"",
    "payment_amount":0.0,
}
var change = 0.0
//Removes all data gathered
function clear(){
    //Sends this to the server through ajax. Data will be appended based on the user activity
    var backEndDataObject = {
        "particularType":"",
        "paymentType" : "",
        "partialAmount" : "",
        "months" : {},
        "tuitionAmount" : {},
        "payments": 0,
        "payment_method":"",
        "ORNumber":"",
        "payment_amount":0.0,
    }
}
$("#particularList").change(function(){
    if ($(this).val() != "None"){
        backEndDataObject.particularType = $(this).val()
        //alert(backEndDataObject.particularType)
    }
});
$("#paymentType").change(function(){
    if ($(this).val() != "None"){
        backEndDataObject.paymentType = $(this).val()
        //alert(backEndDataObject.paymentType)
    }
});

function appendMonth(particularNum){
    if (event.target.value != "None"){
        backEndDataObject.months.push(event.target.value);
        //alert(backEndDataObject.months[toString(particularNum)])
        
    }
}
function recordTuitionPayment(paymentNum){
    if (event.target.value != 0){
        backEndDataObject.tuitionAmount.push(event.target.value);
        updateAmountDue()
    }
}
function recordEnrollmentPartial(){
    if (event.target.value != 0){
        backEndDataObject.partialAmount = event.target.value;
        //alert(backEndDataObject.partialAmount)
    }
}
var othersData = {
    "type" : 'others',
    "name": [],
    "amount" : []

}
function recordSpecName(name, num){
    othersData.name.push(name)
    
}

function recordSpecAmount(money, num){
    othersData.amount.push(money)
    
}

function transferData(num){
    alert(num)
    id = '#item-'+num
    numid = '#amount-'+num
    $(id).html(othersData.name[num])
    $(numid).html(othersData.amount[num])
    
}


var num = 1;
var addParticular = function (){
    
    if(num >=100) return;
  var transaction = '<div class="addParticularPayment">'+
      '<div class="row">'+
        '<div class="col-md-6">'+
          '<label class="card-subtitle">Particular Name:</label>'+
          '<select onchange="particular(value)" class="custom-select btn-block" id="feesParticularList" required>'+
            '<option selected>Choose particular:</option>'+
            '<option value="1">Form 137</option>'+
            '<option value="2">Diploma</option>'+
            '<option value="3">Certificate</option>'+
            '<option value="4">Entrance Test</option>'+
            '<option value="5">Identification Card</option>'+
            '<option value="6">Uniform</option>'+
            '<option value="7">Books</option>'+
            '<option value="others">Others</option>'+
          '</select>'+
          '<div class="modal" tabindex="-1" role="dialog" id="othersModal">'+
            '<div class="modal-dialog modal-sm" role="document">'+
              '<div class="modal-content">'+
                '<div class="modal-header">'+
                  '<h5 class="modal-title">Item details</h5>'+
                  '<button type="button" class="close" data-dismiss="modal" aria-label="Close">'+
                    '<span aria-hidden="true">&times;</span>'+
                  '</button>'+
                '</div>'+
                '<div class="modal-body">'+
                  '<div class="row">'+
                    '<div class="col">'+
                      '<label>Specific Name:</label>'+
                      '<input type="text" class="form-control" onchange="recordSpecName(this.value, '+num+')"/>'+
                    '</div>'+
                  '</div>'+
                  '<div class="row">'+
                    '<div class="col">'+
                      '<label>Price Amount:</label>'+
                      '<input type="text" class="form-control" onchange="recordSpecAmount(this.value, '+num+')"/>'+
                    '</div>'+
                  '</div>'+
                '</div>'+
                '<div class="modal-footer">'+
                  '<button type="button" onclick="transferData(1)"class="btn btn-primary">Save Item</button>'+
                  '<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>'+
                '</div>'+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>'+
        '<div class="col-md-4">'+
          '<div class="others" id="specify">'+
            '<label class="card-subtitle">Specify:</label>'+
            '<h3 class="link" id="item-'+num+'"></h3>'+
           '</div>'+
        '</div>'+
        '<div class="col-md-2">'+
          '<button type="button" class="btn btn-danger btn-sm" onclick="deleteParticularRow(this)">Remove</button>'+
        '</div>'+
      '</div>'+
      '<div class="row">'+
        '<div class="col-md-6">'+
          '<label class="card-subtitle">Price Amount:</label>'+
          '<h2 class="link" "><span class="currency" id="amount-'+num+'> </span></h2>'+
        '</div>'+
      '</div>'+
    '</div>';
    num++
    $('#paymentsPanel').append(transaction);
    alert(num)
};

</script>

{%endblock%}